import React, { useState, useEffect, useRef } from 'react';
import { User, Car, Calendar, Clock, MapPin, Phone, MessageSquare, Upload, Star, Settings, LogOut, Plus, Edit, Trash2, CheckCircle, XCircle, Eye, MessageCircle, X, Send, Paperclip, Smile, MoreVertical, AlertTriangle, Check, FileText, CreditCard, ZoomIn, ZoomOut, Image, Camera, File, Video } from 'lucide-react';

const App = () => {
  // Authentication state
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [currentUser, setCurrentUser] = useState(null);
  const [currentView, setCurrentView] = useState('welcome');
  const [language, setLanguage] = useState('ar');

  // Mock data
  const [users, setUsers] = useState([
    { 
      id: 1, 
      username: 'Ahmed_Owner', 
      password: 'password123', 
      role: 'owner', 
      license: null, 
      phone: '+96891234567', 
      avatar: 'https://placehold.co/100x100/orange/white?text=AO',
      licenseImage: 'https://placehold.co/200x150/orange/white?text=Owner+License'
    },
    { 
      id: 2, 
      username: 'Fatima_Renter', 
      password: 'password123', 
      role: 'renter', 
      license: 'license_image.jpg', 
      phone: '+96897654321', 
      avatar: 'https://placehold.co/100x100/blue/white?text=FR',
      licenseImage: 'https://placehold.co/200x150/blue/white?text=Renter+License'
    }
  ]);

  const [cars, setCars] = useState([
    {
      id: 1,
      ownerId: 1,
      model: 'Toyota Corolla',
      year: 2020,
      photos: ['https://placehold.co/300x200/orange/white?text=Toyota+Corolla'],
      price: 15,
      priceUnit: 'hour',
      availableTimes: [
        { start: '09:00', end: '11:00', date: '2024-01-15' },
        { start: '14:00', end: '16:00', date: '2024-01-15' }
      ],
      location: 'University Parking Lot A',
      status: 'active'
    }
  ]);

  const [bookings, setBookings] = useState([
    {
      id: 1,
      carId: 1,
      renterId: 2,
      ownerId: 1,
      startTime: '09:00',
      endTime: '11:00',
      date: '2024-01-15',
      status: 'pending',
      paymentReceipt: 'https://placehold.co/300x200/green/white?text=Payment+Receipt',
      platformPhone: '+96876944031'
    }
  ]);

  const [messages, setMessages] = useState([
    {
      id: 1,
      bookingId: 1,
      senderId: 2,
      receiverId: 1,
      message: 'Hello! I\'m interested in renting your Toyota Corolla for tomorrow morning. Is it still available?',
      timestamp: new Date(Date.now() - 3600000).toISOString(),
      read: true
    },
    {
      id: 2,
      bookingId: 1,
      senderId: 1,
      receiverId: 2,
      message: 'Hi! Yes, it\'s available from 9:00 AM to 11:00 AM. The price is 15 OMR per hour.',
      timestamp: new Date(Date.now() - 1800000).toISOString(),
      read: true
    },
    {
      id: 3,
      bookingId: 1,
      senderId: 2,
      receiverId: 1,
      message: 'Perfect! I\'d like to book it. What\'s the next step?',
      timestamp: new Date(Date.now() - 600000).toISOString(),
      read: false
    },
    {
      id: 4,
      bookingId: 1,
      senderId: 2,
      receiverId: 1,
      type: 'image',
      content: 'https://placehold.co/300x200/blue/white?text=My+ID+Card',
      timestamp: new Date(Date.now() - 300000).toISOString(),
      read: false
    }
  ]);

  const [currentBookingId, setCurrentBookingId] = useState(null);
  const [newMessage, setNewMessage] = useState('');
  const [selectedCarId, setSelectedCarId] = useState(null);
  const [selectedTimeSlot, setSelectedTimeSlot] = useState(null);
  const [viewingDocument, setViewingDocument] = useState(null);
  const [uploadingFile, setUploadingFile] = useState(false);
  const messagesEndRef = useRef(null);

  // Scroll to bottom of messages
  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  // Translation function
  const t = (key) => {
    const translations = {
      en: {
        login: 'Login',
        signup: 'Sign Up',
        username: 'Username',
        password: 'Password',
        role: 'Role',
        owner: 'Owner',
        renter: 'Renter',
        createListing: 'Create Listing / Add Car',
        availableCars: 'Available Cars',
        carModel: 'Car Model',
        year: 'Year',
        photos: 'Photos',
        price: 'Price',
        perHour: 'Per Hour',
        perDay: 'Per Day',
        availableTimes: 'Available Times',
        location: 'Pickup/Drop-off Location',
        contactNumber: 'Contact Number',
        bookNow: 'Book Now',
        myListings: 'My Listings',
        myBookings: 'My Bookings',
        pending: 'Pending',
        accepted: 'Accepted',
        rejected: 'Rejected',
        uploadReceipt: 'Upload Payment Receipt',
        confirmBooking: 'Confirm Booking',
        chat: 'Chat',
        send: 'Send',
        licenseRequired: 'Driver\'s License Required',
        uploadLicense: 'Upload Driver\'s License',
        platformPhone: 'Platform Phone: +96876944031',
        rating: 'Rating',
        review: 'Review',
        logout: 'Logout',
        settings: 'Settings',
        english: 'English',
        arabic: 'العربية',
        welcome: 'Welcome to University Car Sharing Platform',
        safeSustainable: 'Safe, Smart, and Sustainable Car Sharing for Students',
        transferAmount: 'Please transfer the amount to the platform phone number and upload the receipt below.',
        confirmPayment: 'Confirm Payment',
        cancel: 'Cancel',
        selectTimeSlot: 'Select Time Slot',
        noAvailableSlots: 'No available time slots',
        typeMessage: 'Type your message...',
        online: 'Online',
        offline: 'Offline',
        today: 'Today',
        yesterday: 'Yesterday',
        getStarted: 'Get Started',
        about: 'About',
        features: 'Features',
        contact: 'Contact',
        paymentConfirmation: 'Payment Confirmation',
        receiptSent: 'Payment receipt has been sent to the car owner for approval.',
        viewReceipt: 'View Receipt',
        uploadSuccess: 'Receipt uploaded successfully!',
        paymentApproved: 'Payment Approved',
        paymentRejected: 'Payment Rejected',
        paymentStatus: 'Payment Status',
        pendingApproval: 'Pending Approval',
        approved: 'Approved',
        rejected: 'Rejected',
        universityName: 'University of Technology and Applied Sciences Nizwa',
        campusImageAlt: 'University of Technology and Applied Sciences Nizwa Campus Entrance',
        omaniRial: 'OMR',
        renterDetails: 'Renter Details',
        driverLicense: 'Driver License',
        paymentReceipt: 'Payment Receipt',
        phoneNumber: 'Phone Number',
        viewFullLicense: 'View Full License',
        viewFullReceipt: 'View Full Receipt',
        bookingDetails: 'Booking Details',
        totalAmount: 'Total Amount',
        bookingDate: 'Booking Date',
        bookingTime: 'Booking Time',
        close: 'Close',
        zoomIn: 'Zoom In',
        zoomOut: 'Zoom Out',
        documentViewer: 'Document Viewer',
        sendFile: 'Send File',
        sendImage: 'Send Image',
        sendVideo: 'Send Video',
        file: 'File',
        image: 'Image',
        video: 'Video',
        sending: 'Sending...',
        fileUploaded: 'File uploaded successfully!',
        imageUploaded: 'Image uploaded successfully!',
        videoUploaded: 'Video uploaded successfully!',
        sendMessage: 'Send Message'
      },
      ar: {
        login: 'تسجيل الدخول',
        signup: 'إنشاء حساب',
        username: 'اسم المستخدم',
        password: 'كلمة المرور',
        role: 'الدور',
        owner: 'مالك',
        renter: 'مستأجر',
        createListing: 'إنشاء إعلان / إضافة سيارة',
        availableCars: 'السيارات المتاحة',
        carModel: 'موديل السيارة',
        year: 'السنة',
        photos: 'الصور',
        price: 'السعر',
        perHour: 'بالساعة',
        perDay: 'باليوم',
        availableTimes: 'الأوقات المتاحة',
        location: 'موقع الاستلام/التسليم',
        contactNumber: 'رقم الاتصال',
        bookNow: 'احجز الآن',
        myListings: 'إعلاناتي',
        myBookings: 'حجوزاتي',
        pending: 'قيد الانتظار',
        accepted: 'موافق عليه',
        rejected: 'مرفوض',
        uploadReceipt: 'تحميل إيصال الدفع',
        confirmBooking: 'تأكيد الحجز',
        chat: 'الدردشة',
        send: 'إرسال',
        licenseRequired: 'رخصة القيادة مطلوبة',
        uploadLicense: 'تحميل رخصة القيادة',
        platformPhone: 'هاتف المنصة: +96876944031',
        rating: 'التقييم',
        review: 'المراجعة',
        logout: 'تسجيل الخروج',
        settings: 'الإعدادات',
        english: 'English',
        arabic: 'العربية',
        welcome: 'مرحباً بكم في منصة مشاركة السيارات الجامعية',
        safeSustainable: 'مشاركة سيارات آمنة وذكية ومستدامة للطلاب',
        transferAmount: 'يرجى تحويل المبلغ إلى رقم هاتف المنصة وتحميل الإيصال أدناه.',
        confirmPayment: 'تأكيد الدفع',
        cancel: 'إلغاء',
        selectTimeSlot: 'اختر فتره زمنيه',
        noAvailableSlots: 'لا توجد فترات زمنية متاحة',
        typeMessage: 'اكتب رسالتك...',
        online: 'متصل',
        offline: 'غير متصل',
        today: 'اليوم',
        yesterday: 'أمس',
        getStarted: 'ابدأ الآن',
        about: 'عن المنصة',
        features: 'المميزات',
        contact: 'اتصل بنا',
        paymentConfirmation: 'تأكيد الدفع',
        receiptSent: 'تم إرسال إيصال الدفع إلى مالك السيارة للموافقة.',
        viewReceipt: 'عرض الإيصال',
        uploadSuccess: 'تم تحميل الإيصال بنجاح!',
        paymentApproved: 'تمت الموافقة على الدفع',
        paymentRejected: 'تم رفض الدفع',
        paymentStatus: 'حالة الدفع',
        pendingApproval: 'في انتظار الموافقة',
        approved: 'معتمد',
        rejected: 'مرفوض',
        universityName: 'جامعة التقنية والعلوم التطبيقية نزوى',
        campusImageAlt: 'مدخل حرم جامعة التقنية والعلوم التطبيقية نزوى',
        omaniRial: 'ريال عماني',
        renterDetails: 'تفاصيل المستأجر',
        driverLicense: 'رخصة القيادة',
        paymentReceipt: 'إيصال الدفع',
        phoneNumber: 'رقم الهاتف',
        viewFullLicense: 'عرض الرخصة كاملة',
        viewFullReceipt: 'عرض الإيصال كامل',
        bookingDetails: 'تفاصيل الحجز',
        totalAmount: 'المبلغ الإجمالي',
        bookingDate: 'تاريخ الحجز',
        bookingTime: 'وقت الحجز',
        close: 'إغلاق',
        zoomIn: 'تكبير',
        zoomOut: 'تصغير',
        documentViewer: 'عرض المستند',
        sendFile: 'إرسال ملف',
        sendImage: 'إرسال صورة',
        sendVideo: 'إرسال فيديو',
        file: 'ملف',
        image: 'صورة',
        video: 'فيديو',
        sending: 'جاري الإرسال...',
        fileUploaded: 'تم رفع الملف بنجاح!',
        imageUploaded: 'تم رفع الصورة بنجاح!',
        videoUploaded: 'تم رفع الفيديو بنجاح!',
        sendMessage: 'إرسال الرسالة'
      }
    };
    return translations[language][key] || key;
  };

  // Login function
  const handleLogin = (username, password) => {
    const user = users.find(u => u.username === username && u.password === password);
    if (user) {
      setCurrentUser(user);
      setIsLoggedIn(true);
      setCurrentView(user.role === 'owner' ? 'owner-dashboard' : 'renter-dashboard');
    }
  };

  // Signup function
  const handleSignup = (username, password, role) => {
    if (password.length <= 6) return;
    const newUser = {
      id: users.length + 1,
      username,
      password,
      role,
      license: role === 'renter' ? null : 'not_required',
      phone: '',
      avatar: `https://placehold.co/100x100/${role === 'owner' ? 'orange' : 'blue'}/white?text=${username[0].toUpperCase()}`,
      licenseImage: role === 'renter' ? null : 'https://placehold.co/200x150/orange/white?text=Owner+License'
    };
    setUsers([...users, newUser]);
    setCurrentUser(newUser);
    setIsLoggedIn(true);
    if (role === 'renter') {
      setCurrentView('upload-license');
    } else {
      setCurrentView('owner-dashboard');
    }
  };

  // Logout function
  const handleLogout = () => {
    setIsLoggedIn(false);
    setCurrentUser(null);
    setCurrentView('welcome');
  };

  // Create car listing
  const handleCreateListing = (carData) => {
    const newCar = {
      id: cars.length + 1,
      ownerId: currentUser.id,
      ...carData,
      status: 'active',
      photos: [carData.photos[0] || 'https://placehold.co/300x200/orange/white?text=Car+Photo']
    };
    setCars([...cars, newCar]);
    setCurrentView('owner-dashboard');
  };

  // Create booking
  const handleCreateBooking = (carId, timeSlot) => {
    const newBooking = {
      id: bookings.length + 1,
      carId,
      renterId: currentUser.id,
      ownerId: cars.find(c => c.id === carId).ownerId,
      startTime: timeSlot.start,
      endTime: timeSlot.end,
      date: timeSlot.date,
      status: 'pending',
      paymentReceipt: null,
      platformPhone: '+96876944031'
    };
    setBookings([...bookings, newBooking]);
    setCurrentBookingId(newBooking.id);
    setCurrentView('booking-payment');
  };

  // Handle booking approval
  const handleBookingApproval = (bookingId, approved) => {
    setBookings(bookings.map(b => 
      b.id === bookingId ? { ...b, status: approved ? 'accepted' : 'rejected' } : b
    ));
  };

  // Handle payment approval
  const handlePaymentApproval = (bookingId, approved) => {
    setBookings(bookings.map(b => 
      b.id === bookingId ? { 
        ...b, 
        paymentStatus: approved ? 'approved' : 'rejected',
        status: approved ? 'accepted' : 'rejected'
      } : b
    ));
  };

  // Send message
  const handleSendMessage = () => {
    if (!newMessage.trim()) return;
    const booking = bookings.find(b => b.id === currentBookingId);
    const newMsg = {
      id: messages.length + 1,
      bookingId: currentBookingId,
      senderId: currentUser.id,
      receiverId: currentUser.role === 'owner' ? booking.renterId : booking.ownerId,
      message: newMessage,
      timestamp: new Date().toISOString(),
      read: false
    };
    setMessages([...messages, newMsg]);
    setNewMessage('');
  };

  // Upload file (image, video, document)
  const handleFileUpload = (file, fileType) => {
    setUploadingFile(true);
    
    // Simulate file upload
    setTimeout(() => {
      const booking = bookings.find(b => b.id === currentBookingId);
      const newMsg = {
        id: messages.length + 1,
        bookingId: currentBookingId,
        senderId: currentUser.id,
        receiverId: currentUser.role === 'owner' ? booking.renterId : booking.ownerId,
        type: fileType,
        content: URL.createObjectURL(file),
        timestamp: new Date().toISOString(),
        read: false
      };
      
      setMessages([...messages, newMsg]);
      setUploadingFile(false);
      
      // Show success message
      alert(fileType === 'image' ? t('imageUploaded') : 
            fileType === 'video' ? t('videoUploaded') : t('fileUploaded'));
    }, 1000);
  };

  // Upload license
  const handleLicenseUpload = () => {
    const updatedUser = { 
      ...currentUser, 
      license: 'uploaded_license.jpg',
      licenseImage: 'https://placehold.co/200x150/blue/white?text=Uploaded+License'
    };
    setCurrentUser(updatedUser);
    setUsers(users.map(u => u.id === currentUser.id ? updatedUser : u));
    setCurrentView('renter-dashboard');
  };

  // Handle payment receipt upload
  const handlePaymentReceiptUpload = () => {
    const updatedBooking = bookings.map(b => 
      b.id === currentBookingId ? { 
        ...b, 
        paymentReceipt: 'https://placehold.co/300x200/green/white?text=Payment+Receipt', 
        status: 'pending', 
        paymentStatus: 'pending' 
      } : b
    );
    setBookings(updatedBooking);
    setCurrentView('payment-confirmation');
  };

  // Format timestamp for messages
  const formatMessageTime = (timestamp) => {
    const msgDate = new Date(timestamp);
    const now = new Date();
    const diffInDays = Math.floor((now - msgDate) / (1000 * 60 * 60 * 24));
    
    if (diffInDays === 0) {
      return msgDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    } else if (diffInDays === 1) {
      return `${t('yesterday')} ${msgDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
    } else {
      return msgDate.toLocaleDateString();
    }
  };

  // Document Viewer Component
  const DocumentViewer = ({ documentUrl, title, onClose }) => {
    const [zoomLevel, setZoomLevel] = useState(1);
    const [isFullscreen, setIsFullscreen] = useState(false);

    const handleZoomIn = () => {
      setZoomLevel(prev => Math.min(prev + 0.1, 3));
    };

    const handleZoomOut = () => {
      setZoomLevel(prev => Math.max(prev - 0.1, 0.5));
    };

    const toggleFullscreen = () => {
      setIsFullscreen(!isFullscreen);
    };

    return (
      <div className={`fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 ${isFullscreen ? 'p-0' : 'p-4'}`}>
        <div className={`bg-white rounded-lg shadow-xl w-full max-w-4xl h-[80vh] flex flex-col ${isFullscreen ? 'w-screen h-screen' : ''}`}>
          <div className="flex justify-between items-center p-4 border-b">
            <h2 className="text-xl font-bold text-gray-900">{title}</h2>
            <div className="flex items-center gap-2">
              <button
                onClick={handleZoomIn}
                className="p-2 text-gray-600 hover:text-gray-800"
                title={t('zoomIn')}
              >
                <ZoomIn className="w-5 h-5" />
              </button>
              <button
                onClick={handleZoomOut}
                className="p-2 text-gray-600 hover:text-gray-800"
                title={t('zoomOut')}
              >
                <ZoomOut className="w-5 h-5" />
              </button>
              <button
                onClick={toggleFullscreen}
                className="p-2 text-gray-600 hover:text-gray-800"
                title={isFullscreen ? 'Exit Fullscreen' : 'Enter Fullscreen'}
              >
                <Eye className="w-5 h-5" />
              </button>
              <button
                onClick={onClose}
                className="p-2 text-gray-600 hover:text-gray-800"
                title={t('close')}
              >
                <X className="w-5 h-5" />
              </button>
            </div>
          </div>
          <div className="flex-1 overflow-auto p-4">
            <div className="flex justify-center items-center h-full">
              {documentUrl && (
                <img
                  src={documentUrl}
                  alt={title}
                  className="max-w-full max-h-full object-contain"
                  style={{ transform: `scale(${zoomLevel})`, transformOrigin: 'center' }}
                />
              )}
            </div>
          </div>
        </div>
      </div>
    );
  };

  // File Upload Modal Component
  const FileUploadModal = ({ onUpload, onClose }) => {
    const [selectedFile, setSelectedFile] = useState(null);
    const [fileType, setFileType] = useState('image');
    const [dragActive, setDragActive] = useState(false);

    const handleDrag = (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (e.type === "dragenter" || e.type === "dragover") {
        setDragActive(true);
      } else if (e.type === "dragleave") {
        setDragActive(false);
      }
    };

    const handleDrop = (e) => {
      e.preventDefault();
      e.stopPropagation();
      setDragActive(false);
      if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        setSelectedFile(e.dataTransfer.files[0]);
      }
    };

    const handleFileChange = (e) => {
      if (e.target.files && e.target.files[0]) {
        setSelectedFile(e.target.files[0]);
      }
    };

    const handleUpload = () => {
      if (selectedFile) {
        onUpload(selectedFile, fileType);
        onClose();
      }
    };

    return (
      <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-xl font-bold text-gray-900">Upload {fileType}</h2>
            <button
              onClick={onClose}
              className="text-gray-600 hover:text-gray-800"
            >
              <X className="w-5 h-5" />
            </button>
          </div>

          <div
            className={`border-2 border-dashed rounded-lg p-6 mb-4 ${
              dragActive ? 'border-blue-500 bg-blue-50' : 'border-gray-300'
            }`}
            onDragEnter={handleDrag}
            onDragLeave={handleDrag}
            onDragOver={handleDrag}
            onDrop={handleDrop}
          >
            <div className="text-center">
              <Upload className="w-12 h-12 text-gray-400 mx-auto mb-4" />
              <p className="text-gray-600 mb-2">Drag & drop your file here</p>
              <p className="text-gray-500 text-sm">or</p>
              <input
                type="file"
                onChange={handleFileChange}
                className="mt-4"
              />
            </div>
          </div>

          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-2">File Type</label>
            <select
              value={fileType}
              onChange={(e) => setFileType(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="image">{t('image')}</option>
              <option value="video">{t('video')}</option>
              <option value="file">{t('file')}</option>
            </select>
          </div>

          <div className="flex gap-2">
            <button
              onClick={handleUpload}
              disabled={!selectedFile}
              className="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {t('sendFile')}
            </button>
            <button
              onClick={onClose}
              className="flex-1 border border-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-100 transition-colors"
            >
              {t('cancel')}
            </button>
          </div>
        </div>
      </div>
    );
  };

  // Welcome Page Component
  const WelcomePage = () => {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-blue-50">
        {/* Header */}
        <header className="bg-white shadow-sm">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div className="flex items-center gap-3">
              <Car className="w-8 h-8 text-orange-600" />
              <h1 className="text-xl font-bold text-gray-900">CarShare</h1>
            </div>
            <div className="flex items-center gap-4">
              <button
                onClick={() => setLanguage(language === 'en' ? 'ar' : 'en')}
                className="text-gray-600 hover:text-gray-800 font-medium"
              >
                {language === 'en' ? 'العربية' : 'English'}
              </button>
              <button
                onClick={() => setCurrentView('login')}
                className="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors font-medium"
              >
                {t('getStarted')}
              </button>
            </div>
          </div>
        </header>

        {/* Hero Section */}
        <section className="py-16 px-4 sm:px-6 lg:px-8">
          <div className="max-w-7xl mx-auto">
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
              <div className="text-center lg:text-right">
                <h1 className="text-4xl lg:text-5xl font-bold text-gray-900 mb-6 leading-tight">
                  {language === 'ar' 
                    ? 'مرحباً بكم طلاب الجامعة التقنية والعلوم التطبيقية بنزوى' 
                    : 'Welcome Students of Nizwa University of Technology and Applied Sciences'}
                </h1>
                <p className="text-xl text-gray-600 mb-8 leading-relaxed">
                  {t('safeSustainable')}
                </p>
                <div className="flex flex-col sm:flex-row gap-4 justify-center lg:justify-end">
                  <button
                    onClick={() => setCurrentView('login')}
                    className="bg-orange-600 text-white px-8 py-3 rounded-lg hover:bg-orange-700 transition-colors font-semibold text-lg"
                  >
                    {t('getStarted')}
                  </button>
                  <button
                    onClick={() => {}}
                    className="border-2 border-orange-600 text-orange-600 px-8 py-3 rounded-lg hover:bg-orange-50 transition-colors font-semibold text-lg"
                  >
                    {t('about')}
                  </button>
                </div>
              </div>
              <div className="relative">
                <img
                  src="https://placehold.co/600x400/orange/white?text=University+Car+Sharing"
                  alt={t('campusImageAlt')}
                  className="rounded-2xl shadow-2xl w-full h-auto object-cover"
                />
                <div className="absolute inset-0 bg-gradient-to-t from-orange-600/20 to-transparent rounded-2xl"></div>
              </div>
            </div>
          </div>
        </section>

        {/* Features Section */}
        <section className="py-16 px-4 sm:px-6 lg:px-8 bg-white">
          <div className="max-w-7xl mx-auto">
            <h2 className="text-3xl font-bold text-center text-gray-900 mb-12">{t('features')}</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
              <div className="text-center p-6">
                <div className="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <Car className="w-8 h-8 text-orange-600" />
                </div>
                <h3 className="text-xl font-semibold text-gray-900 mb-2">آمن وموثوق</h3>
                <p className="text-gray-600">نظام تحقق من الهوية وتأمين شامل للسيارات</p>
              </div>
              <div className="text-center p-6">
                <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <Phone className="w-8 h-8 text-blue-600" />
                </div>
                <h3 className="text-xl font-semibold text-gray-900 mb-2">دعم فوري</h3>
                <p className="text-gray-600">خدمة عملاء متاحة على مدار الساعة</p>
              </div>
              <div className="text-center p-6">
                <div className="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <Star className="w-8 h-8 text-orange-600" />
                </div>
                <h3 className="text-xl font-semibold text-gray-900 mb-2">تقييمات موثوقة</h3>
                <p className="text-gray-600">نظام تقييم شفاف لبناء الثقة بين المستخدمين</p>
              </div>
            </div>
          </div>
        </section>

        {/* Footer */}
        <footer className="bg-gray-900 text-white py-12 px-4 sm:px-6 lg:px-8">
          <div className="max-w-7xl mx-auto">
            <div className="text-center">
              <div className="flex items-center justify-center gap-3 mb-4">
                <Car className="w-8 h-8 text-orange-400" />
                <h3 className="text-2xl font-bold">CarShare</h3>
              </div>
              <p className="text-gray-400 mb-6">
                {t('universityName')}
              </p>
              <div className="flex justify-center gap-6">
                <a href="#" className="text-gray-400 hover:text-white transition-colors">{t('contact')}</a>
                <a href="#" className="text-gray-400 hover:text-white transition-colors">{t('about')}</a>
                <a href="#" className="text-gray-400 hover:text-white transition-colors">{t('features')}</a>
              </div>
            </div>
          </div>
        </footer>
      </div>
    );
  };

  // Login Component
  const Login = () => {
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    const [isLogin, setIsLogin] = useState(true);
    const [role, setRole] = useState('renter');

    const handleSubmit = (e) => {
      e.preventDefault();
      if (isLogin) {
        handleLogin(username, password);
      } else {
        handleSignup(username, password, role);
      }
    };

    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-blue-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
          <div className="text-center mb-8">
            <Car className="w-16 h-16 text-orange-600 mx-auto mb-4" />
            <h1 className="text-2xl font-bold text-gray-800 mb-2">{t('welcome')}</h1>
            <p className="text-gray-600">{t('safeSustainable')}</p>
          </div>

          <form onSubmit={handleSubmit} className="space-y-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">{t('username')}</label>
              <input
                type="text"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">{t('password')}</label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                required
                minLength={7}
              />
              {!isLogin && password.length > 0 && password.length <= 6 && (
                <p className="text-red-500 text-sm mt-1">Password must be more than 6 characters</p>
              )}
            </div>

            {!isLogin && (
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">{t('role')}</label>
                <select
                  value={role}
                  onChange={(e) => setRole(e.target.value)}
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                >
                  <option value="renter">{t('renter')}</option>
                  <option value="owner">{t('owner')}</option>
                </select>
              </div>
            )}

            <button
              type="submit"
              className="w-full bg-orange-600 text-white py-3 rounded-lg font-semibold hover:bg-orange-700 transition-colors"
            >
              {isLogin ? t('login') : t('signup')}
            </button>
          </form>

          <div className="mt-6 text-center">
            <button
              onClick={() => setIsLogin(!isLogin)}
              className="text-orange-600 hover:text-orange-800 font-medium"
            >
              {isLogin ? "Don't have an account? Sign Up" : "Already have an account? Login"}
            </button>
          </div>

          <div className="mt-6 flex justify-center">
            <button
              onClick={() => {
                setLanguage(language === 'en' ? 'ar' : 'en');
                setCurrentView('welcome');
              }}
              className="flex items-center gap-2 text-gray-600 hover:text-gray-800"
            >
              <GlobeIcon />
              {language === 'en' ? t('arabic') : t('english')}
            </button>
          </div>
        </div>
      </div>
    );
  };

  // Owner Dashboard Component
  const OwnerDashboard = () => {
    const myCars = cars.filter(car => car.ownerId === currentUser.id);
    const myBookings = bookings.filter(booking => booking.ownerId === currentUser.id);

    return (
      <div className="min-h-screen bg-gray-50">
        <header className="bg-white shadow-sm border-b">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div className="flex items-center gap-3">
              <Car className="w-8 h-8 text-orange-600" />
              <h1 className="text-xl font-bold text-gray-900">CarShare</h1>
            </div>
            <div className="flex items-center gap-4">
              <button
                onClick={() => setLanguage(language === 'en' ? 'ar' : 'en')}
                className="text-gray-600 hover:text-gray-800"
              >
                {language === 'en' ? 'العربية' : 'English'}
              </button>
              <button
                onClick={handleLogout}
                className="flex items-center gap-2 text-gray-600 hover:text-gray-800"
              >
                <LogOut className="w-4 h-4" />
                {t('logout')}
              </button>
            </div>
          </div>
        </header>

        <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          <div className="mb-8">
            <h2 className="text-2xl font-bold text-gray-900 mb-4">{t('myListings')}</h2>
            <button
              onClick={() => setCurrentView('create-listing')}
              className="flex items-center gap-2 bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors"
            >
              <Plus className="w-4 h-4" />
              {t('createListing')}
            </button>
          </div>

          {/* My Cars */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            {myCars.map(car => (
              <div key={car.id} className="bg-white rounded-lg shadow-md p-6 border border-orange-100">
                <img
                  src={car.photos[0]}
                  alt={car.model}
                  className="w-full h-48 object-cover rounded-lg mb-4"
                />
                <h3 className="text-lg font-semibold text-gray-900">{car.model}</h3>
                <p className="text-gray-600">{car.year}</p>
                <p className="text-orange-600 font-semibold mt-2">
                  {car.price} {t('omaniRial')} {t(car.priceUnit === 'hour' ? 'perHour' : 'perDay')}
                </p>
                <div className="flex gap-2 mt-4">
                  <button className="flex items-center gap-1 text-blue-600 hover:text-blue-800">
                    <Edit className="w-4 h-4" />
                    Edit
                  </button>
                  <button className="flex items-center gap-1 text-red-600 hover:text-red-800">
                    <Trash2 className="w-4 h-4" />
                    Delete
                  </button>
                </div>
              </div>
            ))}
          </div>

          {/* My Bookings */}
          <div>
            <h2 className="text-2xl font-bold text-gray-900 mb-4">{t('myBookings')}</h2>
            <div className="space-y-4">
              {myBookings.map(booking => {
                const car = cars.find(c => c.id === booking.carId);
                const renter = users.find(u => u.id === booking.renterId);
                return (
                  <div key={booking.id} className="bg-white rounded-lg shadow-md p-6 border-l-4 border-orange-500">
                    <div className="flex justify-between items-start mb-4">
                      <div>
                        <h3 className="text-lg font-semibold text-gray-900">{car?.model}</h3>
                        <p className="text-gray-600">
                          {booking.date} • {booking.startTime} - {booking.endTime}
                        </p>
                        <p className="text-orange-600 font-semibold mt-1">
                          {t('totalAmount')}: {car?.price} {t('omaniRial')}
                        </p>
                        <span className={`inline-block px-2 py-1 rounded-full text-xs font-semibold mt-2 ${
                          booking.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                          booking.status === 'accepted' ? 'bg-green-100 text-green-800' :
                          'bg-red-100 text-red-800'
                        }`}>
                          {t(booking.status)}
                        </span>
                      </div>
                      {booking.status === 'pending' && (
                        <div className="flex gap-2">
                          <button
                            onClick={() => handleBookingApproval(booking.id, true)}
                            className="flex items-center gap-1 bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700"
                          >
                            <CheckCircle className="w-4 h-4" />
                            Accept
                          </button>
                          <button
                            onClick={() => handleBookingApproval(booking.id, false)}
                            className="flex items-center gap-1 bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700"
                          >
                            <XCircle className="w-4 h-4" />
                            Reject
                          </button>
                        </div>
                      )}
                    </div>

                    {/* Renter Details Section */}
                    {booking.status === 'pending' && (
                      <div className="bg-gray-50 rounded-lg p-4 mb-4">
                        <h4 className="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                          <User className="w-4 h-4" />
                          {t('renterDetails')}
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <p className="text-sm text-gray-600 mb-1">{t('phoneNumber')}</p>
                            <p className="font-medium">{renter?.phone || 'N/A'}</p>
                          </div>
                          <div>
                            <p className="text-sm text-gray-600 mb-1">{t('driverLicense')}</p>
                            {renter?.licenseImage ? (
                              <div className="flex items-center gap-2">
                                <img
                                  src={renter.licenseImage}
                                  alt="Driver License"
                                  className="w-24 h-18 object-cover rounded border cursor-pointer"
                                  onClick={() => setViewingDocument({
                                    url: renter.licenseImage,
                                    title: t('driverLicense')
                                  })}
                                />
                                <button
                                  onClick={() => setViewingDocument({
                                    url: renter.licenseImage,
                                    title: t('driverLicense')
                                  })}
                                  className="text-blue-600 hover:text-blue-800 text-sm"
                                >
                                  {t('viewFullLicense')}
                                </button>
                              </div>
                            ) : (
                              <p className="text-gray-500">Not uploaded</p>
                            )}
                          </div>
                          <div className="md:col-span-2">
                            <p className="text-sm text-gray-600 mb-1">{t('paymentReceipt')}</p>
                            {booking.paymentReceipt ? (
                              <div className="flex items-center gap-2">
                                <img
                                  src={booking.paymentReceipt}
                                  alt="Payment Receipt"
                                  className="w-32 h-24 object-cover rounded border cursor-pointer"
                                  onClick={() => setViewingDocument({
                                    url: booking.paymentReceipt,
                                    title: t('paymentReceipt')
                                  })}
                                />
                                <button
                                  onClick={() => setViewingDocument({
                                    url: booking.paymentReceipt,
                                    title: t('paymentReceipt')
                                  })}
                                  className="text-blue-600 hover:text-blue-800 text-sm"
                                >
                                  {t('viewFullReceipt')}
                                </button>
                              </div>
                            ) : (
                              <p className="text-gray-500">Not uploaded</p>
                            )}
                          </div>
                        </div>
                      </div>
                    )}

                    <button
                      onClick={() => {
                        setCurrentBookingId(booking.id);
                        setCurrentView('chat');
                      }}
                      className="flex items-center gap-2 text-orange-600 hover:text-orange-800 mt-4"
                    >
                      <MessageCircle className="w-4 h-4" />
                      {t('chat')}
                    </button>
                  </div>
                );
              })}
            </div>
          </div>
        </main>
      </div>
    );
  };

  // Renter Dashboard Component
  const RenterDashboard = () => {
    const availableCars = cars.filter(car => car.status === 'active');
    const myBookings = bookings.filter(booking => booking.renterId === currentUser.id);

    return (
      <div className="min-h-screen bg-gray-50">
        <header className="bg-white shadow-sm border-b">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div className="flex items-center gap-3">
              <Car className="w-8 h-8 text-orange-600" />
              <h1 className="text-xl font-bold text-gray-900">CarShare</h1>
            </div>
            <div className="flex items-center gap-4">
              <button
                onClick={() => setLanguage(language === 'en' ? 'ar' : 'en')}
                className="text-gray-600 hover:text-gray-800"
              >
                {language === 'en' ? 'العربية' : 'English'}
              </button>
              <button
                onClick={handleLogout}
                className="flex items-center gap-2 text-gray-600 hover:text-gray-800"
              >
                <LogOut className="w-4 h-4" />
                {t('logout')}
              </button>
            </div>
          </div>
        </header>

        <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          <h2 className="text-2xl font-bold text-gray-900 mb-6">{t('availableCars')}</h2>

          {/* Available Cars */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            {availableCars.map(car => {
              const owner = users.find(u => u.id === car.ownerId);
              return (
                <div key={car.id} className="bg-white rounded-lg shadow-md p-6 border border-blue-100">
                  <img
                    src={car.photos[0]}
                    alt={car.model}
                    className="w-full h-48 object-cover rounded-lg mb-4"
                  />
                  <h3 className="text-lg font-semibold text-gray-900">{car.model}</h3>
                  <p className="text-gray-600">{car.year}</p>
                  <p className="text-orange-600 font-semibold mt-2">
                    {car.price} {t('omaniRial')} {t(car.priceUnit === 'hour' ? 'perHour' : 'perDay')}
                  </p>
                  <p className="text-gray-600 flex items-center gap-1 mt-2">
                    <MapPin className="w-4 h-4" />
                    {car.location}
                  </p>
                  <p className="text-gray-600 flex items-center gap-1 mt-1">
                    <Phone className="w-4 h-4" />
                    {owner?.phone || 'Contact after booking'}
                  </p>
                  <button
                    onClick={() => {
                      // Check if license is uploaded for renters
                      if (currentUser.role === 'renter' && !currentUser.license) {
                        setCurrentView('upload-license');
                        return;
                      }
                      setSelectedCarId(car.id);
                      setCurrentView('select-time-slot');
                    }}
                    className="w-full bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition-colors mt-4"
                  >
                    {t('bookNow')}
                  </button>
                </div>
              );
            })}
          </div>

          {/* My Bookings */}
          <div>
            <h2 className="text-2xl font-bold text-gray-900 mb-4">{t('myBookings')}</h2>
            <div className="space-y-4">
              {myBookings.map(booking => {
                const car = cars.find(c => c.id === booking.carId);
                return (
                  <div key={booking.id} className="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
                    <div className="flex justify-between items-start">
                      <div>
                        <h3 className="text-lg font-semibold text-gray-900">{car?.model}</h3>
                        <p className="text-gray-600">
                          {booking.date} • {booking.startTime} - {booking.endTime}
                        </p>
                        <p className="text-orange-600 font-semibold mt-1">
                          {t('totalAmount')}: {car?.price} {t('omaniRial')}
                        </p>
                        <span className={`inline-block px-2 py-1 rounded-full text-xs font-semibold mt-2 ${
                          booking.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                          booking.status === 'accepted' ? 'bg-green-100 text-green-800' :
                          'bg-red-100 text-red-800'
                        }`}>
                          {t(booking.status)}
                        </span>
                      </div>
                      {booking.status === 'pending' && !booking.paymentReceipt && (
                        <button
                          onClick={() => {
                            setCurrentBookingId(booking.id);
                            setCurrentView('booking-payment');
                          }}
                          className="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700"
                        >
                          {t('uploadReceipt')}
                        </button>
                      )}
                      {booking.status === 'pending' && booking.paymentReceipt && !booking.paymentStatus && (
                        <button
                          onClick={() => {
                            setCurrentBookingId(booking.id);
                            setCurrentView('payment-confirmation');
                          }}
                          className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                        >
                          {t('viewReceipt')}
                        </button>
                      )}
                    </div>
                    {booking.status === 'accepted' && (
                      <div className="mt-4 p-4 bg-green-50 rounded-lg">
                        <p className="text-green-800 font-medium">{t('platformPhone')}</p>
                      </div>
                    )}
                    <button
                      onClick={() => {
                        setCurrentBookingId(booking.id);
                        setCurrentView('chat');
                      }}
                      className="flex items-center gap-2 text-orange-600 hover:text-orange-800 mt-4"
                    >
                      <MessageCircle className="w-4 h-4" />
                      {t('chat')}
                    </button>
                  </div>
                );
              })}
            </div>
          </div>
        </main>
      </div>
    );
  };

  // Create Listing Component
  const CreateListing = () => {
    const [formData, setFormData] = useState({
      model: '',
      year: '',
      photos: ['https://placehold.co/300x200/orange/white?text=Car+Photo'],
      price: '',
      priceUnit: 'hour',
      availableTimes: [{ start: '', end: '', date: '' }],
      location: ''
    });

    const handleSubmit = (e) => {
      e.preventDefault();
      handleCreateListing(formData);
    };

    const addTimeSlot = () => {
      setFormData({
        ...formData,
        availableTimes: [...formData.availableTimes, { start: '', end: '', date: '' }]
      });
    };

    const removeTimeSlot = (index) => {
      const newTimes = formData.availableTimes.filter((_, i) => i !== index);
      setFormData({ ...formData, availableTimes: newTimes });
    };

    const updateTimeSlot = (index, field, value) => {
      const newTimes = formData.availableTimes.map((slot, i) =>
        i === index ? { ...slot, [field]: value } : slot
      );
      setFormData({ ...formData, availableTimes: newTimes });
    };

    return (
      <div className="min-h-screen bg-gray-50">
        <header className="bg-white shadow-sm border-b">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <button
              onClick={() => setCurrentView('owner-dashboard')}
              className="text-orange-600 hover:text-orange-800"
            >
              ← Back to Dashboard
            </button>
            <h1 className="text-xl font-bold text-gray-900">{t('createListing')}</h1>
          </div>
        </header>

        <main className="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          <form onSubmit={handleSubmit} className="space-y-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">{t('carModel')}</label>
              <input
                type="text"
                value={formData.model}
                onChange={(e) => setFormData({ ...formData, model: e.target.value })}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">{t('year')}</label>
              <input
                type="number"
                value={formData.year}
                onChange={(e) => setFormData({ ...formData, year: e.target.value })}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                required
                min="1990"
                max="2024"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">{t('photos')}</label>
              <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                <img
                  src={formData.photos[0]}
                  alt="Car preview"
                  className="w-full h-48 object-cover rounded-lg mb-4"
                />
                <Upload className="w-8 h-8 text-gray-400 mx-auto mb-2" />
                <p className="text-gray-600 text-sm">Car photo (mandatory)</p>
                <input 
                  type="file" 
                  accept="image/*"
                  onChange={(e) => {
                    if (e.target.files[0]) {
                      const reader = new FileReader();
                      reader.onload = (event) => {
                        setFormData({ ...formData, photos: [event.target.result] });
                      };
                      reader.readAsDataURL(e.target.files[0]);
                    }
                  }}
                  className="mt-2"
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">{t('price')}</label>
                <input
                  type="number"
                  value={formData.price}
                  onChange={(e) => setFormData({ ...formData, price: e.target.value })}
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                  required
                  min="1"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Unit</label>
                <select
                  value={formData.priceUnit}
                  onChange={(e) => setFormData({ ...formData, priceUnit: e.target.value })}
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                >
                  <option value="hour">{t('perHour')}</option>
                  <option value="day">{t('perDay')}</option>
                </select>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">{t('availableTimes')}</label>
              {formData.availableTimes.map((slot, index) => (
                <div key={index} className="grid grid-cols-3 gap-2 mb-2">
                  <input
                    type="date"
                    value={slot.date}
                    onChange={(e) => updateTimeSlot(index, 'date', e.target.value)}
                    className="px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                    required
                  />
                  <input
                    type="time"
                    value={slot.start}
                    onChange={(e) => updateTimeSlot(index, 'start', e.target.value)}
                    className="px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                    required
                  />
                  <input
                    type="time"
                    value={slot.end}
                    onChange={(e) => updateTimeSlot(index, 'end', e.target.value)}
                    className="px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                    required
                  />
                  {index > 0 && (
                    <button
                      type="button"
                      onClick={() => removeTimeSlot(index)}
                      className="text-red-600 hover:text-red-800 col-span-3 mt-2"
                    >
                      Remove Time Slot
                    </button>
                  )}
                </div>
              ))}
              <button
                type="button"
                onClick={addTimeSlot}
                className="text-orange-600 hover:text-orange-800"
              >
                + Add Time Slot
              </button>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">{t('location')}</label>
              <input
                type="text"
                value={formData.location}
                onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                required
              />
            </div>

            <button
              type="submit"
              className="w-full bg-orange-600 text-white py-3 rounded-lg font-semibold hover:bg-orange-700 transition-colors"
            >
              Create Listing
            </button>
          </form>
        </main>
      </div>
    );
  };

  // Upload License Component
  const UploadLicense = () => {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-blue-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
          <div className="text-center mb-6">
            <User className="w-16 h-16 text-orange-600 mx-auto mb-4" />
            <h2 className="text-xl font-bold text-gray-900">{t('licenseRequired')}</h2>
            <p className="text-gray-600 mt-2">Please upload your valid driver's license to continue</p>
          </div>

          <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-6">
            <Upload className="w-12 h-12 text-gray-400 mx-auto mb-4" />
            <p className="text-gray-600">Upload Driver's License</p>
            <input type="file" className="mt-2" accept="image/*" />
          </div>

          <button
            onClick={handleLicenseUpload}
            className="w-full bg-orange-600 text-white py-3 rounded-lg font-semibold hover:bg-orange-700 transition-colors"
          >
            {t('uploadLicense')}
          </button>

          <button
            onClick={() => setCurrentView('renter-dashboard')}
            className="w-full mt-4 text-gray-600 hover:text-gray-800"
          >
            {t('cancel')}
          </button>
        </div>
      </div>
    );
  };

  // Select Time Slot Component
  const SelectTimeSlot = () => {
    const car = cars.find(c => c.id === selectedCarId);
    if (!car) return null;

    const handleSelectTimeSlot = (timeSlot) => {
      setSelectedTimeSlot(timeSlot);
      handleCreateBooking(selectedCarId, timeSlot);
    };

    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-blue-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
          <div className="flex justify-between items-center mb-6">
            <button
              onClick={() => setCurrentView('renter-dashboard')}
              className="text-gray-600 hover:text-gray-800"
            >
              <X className="w-6 h-6" />
            </button>
            <h2 className="text-xl font-bold text-gray-900">{t('selectTimeSlot')}</h2>
            <div></div>
          </div>

          <div className="mb-6">
            <img
              src={car.photos[0]}
              alt={car.model}
              className="w-full h-48 object-cover rounded-lg mb-4"
            />
            <h3 className="text-lg font-semibold text-gray-900">{car.model}</h3>
            <p className="text-gray-600">{car.year}</p>
            <p className="text-orange-600 font-semibold mt-2">
              {car.price} {t('omaniRial')} {t(car.priceUnit === 'hour' ? 'perHour' : 'perDay')}
            </p>
          </div>

          <div className="space-y-3">
            {car.availableTimes.length > 0 ? (
              car.availableTimes.map((slot, index) => (
                <button
                  key={index}
                  onClick={() => handleSelectTimeSlot(slot)}
                  className="w-full p-4 border border-gray-200 rounded-lg hover:border-orange-300 hover:bg-orange-50 text-left transition-colors"
                >
                  <div className="font-medium">{slot.date}</div>
                  <div className="text-gray-600">{slot.start} - {slot.end}</div>
                </button>
              ))
            ) : (
              <p className="text-gray-600 text-center py-8">{t('noAvailableSlots')}</p>
            )}
          </div>
        </div>
      </div>
    );
  };

  // Booking Payment Component
  const BookingPayment = () => {
    const booking = bookings.find(b => b.id === currentBookingId);
    const car = cars.find(c => c.id === booking?.carId);

    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-blue-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
          <div className="flex justify-between items-center mb-6">
            <button
              onClick={() => setCurrentView('renter-dashboard')}
              className="text-gray-600 hover:text-gray-800"
            >
              <X className="w-6 h-6" />
            </button>
            <h2 className="text-xl font-bold text-gray-900">{t('confirmBooking')}</h2>
            <div></div>
          </div>

          {car && booking && (
            <>
              <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                <h3 className="font-semibold text-gray-900">{car.model}</h3>
                <p className="text-gray-600">{booking.date} • {booking.startTime} - {booking.endTime}</p>
                <p className="text-orange-600 font-semibold mt-2">
                  {t('totalAmount')}: {car.price} {t('omaniRial')}
                </p>
              </div>

              <div className="mb-6 p-4 bg-orange-50 rounded-lg border border-orange-200">
                <p className="text-orange-800 font-medium text-center">{t('platformPhone')}</p>
                <p className="text-orange-600 text-sm mt-2 text-center">{t('transferAmount')}</p>
              </div>

              <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-6">
                <Upload className="w-12 h-12 text-gray-400 mx-auto mb-4" />
                <p className="text-gray-600">{t('uploadReceipt')}</p>
                <input type="file" className="mt-2" accept="image/*" />
              </div>

              <button
                onClick={handlePaymentReceiptUpload}
                className="w-full bg-orange-600 text-white py-3 rounded-lg font-semibold hover:bg-orange-700 transition-colors mb-4"
              >
                {t('confirmPayment')}
              </button>

              <button
                onClick={() => setCurrentView('renter-dashboard')}
                className="w-full text-gray-600 hover:text-gray-800"
              >
                {t('cancel')}
              </button>
            </>
          )}
        </div>
      </div>
    );
  };

  // Payment Confirmation Component
  const PaymentConfirmation = () => {
    const booking = bookings.find(b => b.id === currentBookingId);
    const car = cars.find(c => c.id === booking?.carId);
    const owner = users.find(u => u.id === booking?.ownerId);

    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-blue-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
          <div className="flex justify-between items-center mb-6">
            <button
              onClick={() => setCurrentView('renter-dashboard')}
              className="text-gray-600 hover:text-gray-800"
            >
              <X className="w-6 h-6" />
            </button>
            <h2 className="text-xl font-bold text-gray-900">{t('paymentConfirmation')}</h2>
            <div></div>
          </div>

          {car && booking && (
            <>
              <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                <h3 className="font-semibold text-gray-900">{car.model}</h3>
                <p className="text-gray-600">{booking.date} • {booking.startTime} - {booking.endTime}</p>
                <p className="text-orange-600 font-semibold mt-2">
                  {t('totalAmount')}: {car.price} {t('omaniRial')}
                </p>
              </div>

              <div className="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <div className="flex items-center gap-2 mb-2">
                  <Check className="w-5 h-5 text-blue-600" />
                  <p className="font-medium text-blue-800">{t('receiptSent')}</p>
                </div>
                <p className="text-blue-600 text-sm">
                  {t('paymentStatus')}: {booking.paymentStatus || t('pendingApproval')}
                </p>
              </div>

              {booking.paymentReceipt && (
                <div className="mb-6">
                  <h4 className="font-semibold text-gray-900 mb-2 flex items-center gap-2">
                    <FileText className="w-4 h-4" />
                    {t('paymentReceipt')}
                  </h4>
                  <img
                    src={booking.paymentReceipt}
                    alt="Payment Receipt"
                    className="w-full h-auto object-cover rounded-lg cursor-pointer"
                    onClick={() => setViewingDocument({
                      url: booking.paymentReceipt,
                      title: t('paymentReceipt')
                    })}
                  />
                  <button
                    onClick={() => setViewingDocument({
                      url: booking.paymentReceipt,
                      title: t('paymentReceipt')
                    })}
                    className="mt-2 text-blue-600 hover:text-blue-800 text-sm"
                  >
                    {t('viewFullReceipt')}
                  </button>
                </div>
              )}

              {booking.paymentStatus === 'approved' && (
                <div className="mb-6 p-4 bg-green-50 rounded-lg border border-green-200">
                  <div className="flex items-center gap-2 mb-2">
                    <CheckCircle className="w-5 h-5 text-green-600" />
                    <p className="font-medium text-green-800">{t('paymentApproved')}</p>
                  </div>
                  <p className="text-green-600 text-sm">
                    {t('platformPhone')}
                  </p>
                </div>
              )}

              {booking.paymentStatus === 'rejected' && (
                <div className="mb-6 p-4 bg-red-50 rounded-lg border border-red-200">
                  <div className="flex items-center gap-2 mb-2">
                    <AlertTriangle className="w-5 h-5 text-red-600" />
                    <p className="font-medium text-red-800">{t('paymentRejected')}</p>
                  </div>
                  <p className="text-red-600 text-sm">
                    Please contact the car owner for more information.
                  </p>
                </div>
              )}

              <button
                onClick={() => setCurrentView('renter-dashboard')}
                className="w-full bg-orange-600 text-white py-3 rounded-lg font-semibold hover:bg-orange-700 transition-colors"
              >
                {t('backToDashboard')}
              </button>
            </>
          )}
        </div>
      </div>
    );
  };

  // Enhanced Chat Component
  const Chat = () => {
    const [showFileUploadModal, setShowFileUploadModal] = useState(false);
    const booking = bookings.find(b => b.id === currentBookingId);
    const otherUser = users.find(u => 
      u.id === (currentUser.role === 'owner' ? booking?.renterId : booking?.ownerId)
    );
    const bookingMessages = messages.filter(m => m.bookingId === currentBookingId);
    const car = cars.find(c => c.id === booking?.carId);

    // Mark messages as read
    useEffect(() => {
      if (bookingMessages.length > 0) {
        const unreadMessages = bookingMessages.filter(msg => 
          msg.receiverId === currentUser.id && !msg.read
        );
        if (unreadMessages.length > 0) {
          setMessages(prev => prev.map(msg => 
            unreadMessages.find(unread => unread.id === msg.id) 
              ? { ...msg, read: true } 
              : msg
          ));
        }
      }
    }, [bookingMessages, currentUser.id]);

    const otherUserOnline = true; // In a real app, this would be based on actual online status

    return (
      <div className="min-h-screen bg-gray-50">
        <header className="bg-white shadow-sm border-b">
          <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <button
              onClick={() => setCurrentView(currentUser.role === 'owner' ? 'owner-dashboard' : 'renter-dashboard')}
              className="text-gray-600 hover:text-gray-800"
            >
              ← Back
            </button>
            <div className="flex items-center gap-3">
              <div className="relative">
                <img
                  src={otherUser?.avatar}
                  alt={otherUser?.username}
                  className="w-10 h-10 rounded-full"
                />
                {otherUserOnline && (
                  <div className="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                )}
              </div>
              <div>
                <h2 className="font-semibold text-gray-900">{otherUser?.username}</h2>
                <p className="text-sm text-gray-600">
                  {otherUserOnline ? t('online') : t('offline')}
                </p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <button className="text-gray-600 hover:text-gray-800">
                <MoreVertical className="w-5 h-5" />
              </button>
            </div>
          </div>
        </header>

        <main className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          {/* Car info banner */}
          {car && (
            <div className="bg-white rounded-lg shadow-sm p-4 mb-4 flex items-center gap-3 border-l-4 border-orange-500">
              <img
                src={car.photos[0]}
                alt={car.model}
                className="w-12 h-12 object-cover rounded"
              />
              <div>
                <p className="font-medium text-gray-900 text-sm">{car.model}</p>
                <p className="text-gray-600 text-xs">
                  {booking?.date} • {booking?.startTime} - {booking?.endTime}
                </p>
              </div>
            </div>
          )}

          {/* Messages container */}
          <div className="bg-white rounded-lg shadow-md h-96 overflow-y-auto p-4 mb-4">
            {bookingMessages.map(msg => {
              const isOwnMessage = msg.senderId === currentUser.id;
              const sender = users.find(u => u.id === msg.senderId);
              
              return (
                <div
                  key={msg.id}
                  className={`mb-4 ${isOwnMessage ? 'text-right' : 'text-left'}`}
                >
                  {!isOwnMessage && (
                    <div className="flex items-center gap-2 mb-1">
                      <img
                        src={sender?.avatar}
                        alt={sender?.username}
                        className="w-6 h-6 rounded-full"
                      />
                      <span className="text-xs font-medium text-gray-700">
                        {sender?.username}
                      </span>
                    </div>
                  )}
                  {msg.type === 'image' ? (
                    <div
                      className={`inline-block p-2 rounded-2xl max-w-xs lg:max-w-md ${
                        isOwnMessage
                          ? 'bg-orange-600 text-white rounded-br-none'
                          : 'bg-gray-100 text-gray-800 rounded-bl-none'
                      }`}
                    >
                      <img
                        src={msg.content}
                        alt="Shared image"
                        className="max-w-full max-h-48 object-cover rounded"
                      />
                    </div>
                  ) : msg.type === 'video' ? (
                    <div
                      className={`inline-block p-2 rounded-2xl max-w-xs lg:max-w-md ${
                        isOwnMessage
                          ? 'bg-orange-600 text-white rounded-br-none'
                          : 'bg-gray-100 text-gray-800 rounded-bl-none'
                      }`}
                    >
                      <video
                        src={msg.content}
                        controls
                        className="max-w-full max-h-48 object-cover rounded"
                      />
                    </div>
                  ) : msg.type === 'file' ? (
                    <div
                      className={`inline-block p-2 rounded-2xl max-w-xs lg:max-w-md ${
                        isOwnMessage
                          ? 'bg-orange-600 text-white rounded-br-none'
                          : 'bg-gray-100 text-gray-800 rounded-bl-none'
                      }`}
                    >
                      <div className="flex items-center gap-2">
                        <File className="w-5 h-5" />
                        <span>Shared file</span>
                      </div>
                    </div>
                  ) : (
                    <div
                      className={`inline-block p-3 rounded-2xl max-w-xs lg:max-w-md ${
                        isOwnMessage
                          ? 'bg-orange-600 text-white rounded-br-none'
                          : 'bg-gray-100 text-gray-800 rounded-bl-none'
                      }`}
                    >
                      <p className="text-sm">{msg.message}</p>
                    </div>
                  )}
                  <p className={`text-xs text-gray-500 mt-1 ${
                    isOwnMessage ? 'text-right' : 'text-left'
                  }`}>
                    {formatMessageTime(msg.timestamp)}
                    {isOwnMessage && !msg.read && (
                      <span className="ml-1">✓✓</span>
                    )}
                    {isOwnMessage && msg.read && (
                      <span className="ml-1 text-blue-500">✓✓</span>
                    )}
                  </p>
                </div>
              );
            })}
            <div ref={messagesEndRef} />
          </div>

          {/* Message input */}
          <div className="bg-white rounded-lg shadow-sm p-3 flex items-center gap-2 border-t">
            <button
              onClick={() => setShowFileUploadModal(true)}
              className="text-gray-500 hover:text-gray-700"
            >
              <Paperclip className="w-5 h-5" />
            </button>
            <button className="text-gray-500 hover:text-gray-700">
              <Smile className="w-5 h-5" />
            </button>
            <input
              type="text"
              value={newMessage}
              onChange={(e) => setNewMessage(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
              placeholder={t('typeMessage')}
              className="flex-1 px-3 py-2 border-none focus:ring-0 text-sm"
            />
            <button
              onClick={handleSendMessage}
              disabled={!newMessage.trim()}
              className="bg-orange-600 text-white p-2 rounded-full hover:bg-orange-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <Send className="w-4 h-4" />
            </button>
          </div>
        </main>

        {/* File Upload Modal */}
        {showFileUploadModal && (
          <FileUploadModal
            onUpload={handleFileUpload}
            onClose={() => setShowFileUploadModal(false)}
          />
        )}
      </div>
    );
  };

  // Render current view
  if (currentView === 'welcome') {
    return <WelcomePage />;
  }

  if (!isLoggedIn) {
    return <Login />;
  }

  return (
    <>
      {currentView === 'owner-dashboard' && <OwnerDashboard />}
      {currentView === 'renter-dashboard' && <RenterDashboard />}
      {currentView === 'create-listing' && <CreateListing />}
      {currentView === 'upload-license' && <UploadLicense />}
      {currentView === 'select-time-slot' && <SelectTimeSlot />}
      {currentView === 'booking-payment' && <BookingPayment />}
      {currentView === 'payment-confirmation' && <PaymentConfirmation />}
      {currentView === 'chat' && <Chat />}
      
      {/* Document Viewer */}
      {viewingDocument && (
        <DocumentViewer
          documentUrl={viewingDocument.url}
          title={viewingDocument.title}
          onClose={() => setViewingDocument(null)}
        />
      )}
    </>
  );
};

// Globe icon component
const GlobeIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <circle cx="12" cy="12" r="10"></circle>
    <line x1="2" y1="12" x2="22" y2="12"></line>
    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
  </svg>
);

export default App;
